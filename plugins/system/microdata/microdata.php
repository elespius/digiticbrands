<?php
/**
 * @package     Joomla.Plugin
 * @subpackage  System.Microdata
 *
 * @copyright   Copyright (C) 2005 - 2014 Open Source Matters, Inc. All rights reserved.
 * @license     GNU General Public License version 2 or later; see LICENSE
 */

defined('JPATH_BASE') or die;

/**
 * System Plugin for parsing the HTML markup and convert
 * the data-sd HTML5 attributes in Microdata semantics.
 *
 * @package     Joomla.Plugin
 * @subpackage  System.Microdata
 * @since       3.2
 */
class PlgSystemMicrodata extends JPlugin
{
	/**
	 * Parse the HTML markup and convert the data-sd HTML5 attributes in Microdata semantics,
	 * after that all the HTML was generated by the application logic.
	 *
	 * @return boolean True on success
	 *
	 * @since 3.2
	 */
	public function onAfterRender()
	{
		$app = JFactory::getApplication();

		// Prevent admin execution, and non HTML documents.
		if ($app->isAdmin()
			|| $app->getDocument()->getType() !== 'html')
		{
			return true;
		}

		// Prevent site execution when editing
		if ($app->isSite() && $app->input->get('layout') == 'edit')
		{
			return true;
		}

		// Retrieve the params
		$suffix = explode(',', $this->params->get('suffix', 'sd'));

		// Get the body HTML
		$output = $app->getBody();

		// Make an instance of the parser
		$parser = new JMicrodataParser($suffix);

		// Set the body HTML
		$app->setBody($parser->parse($output));
	}
}
