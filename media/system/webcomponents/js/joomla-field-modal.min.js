/* eslint-env browser, es6, node */
/* jshint esversion: 6 */
((customElements,Joomla,$)=>{const ALLOW_NEW=1,ALLOW_EDIT=2,ALLOW_CLEAR=4,ALLOW_SELECT=8;function getElement(t,e,...s){const l=document.createElement(t);return e&&Object.keys(e).forEach(t=>l.setAttribute(t,e[t])),s.forEach(t=>{"string"==typeof t?l.appendChild(document.createTextNode(t)):t instanceof HTMLElement&&l.appendChild(t)}),l}function templateFactory(tmpl){const safe=tmpl.replace(/\\|`/g,"\\$&");function template(t,...e){return(...s)=>{const l=e.map((e,l)=>t[l]+s[parseInt(e,10)]);return l.push(t[t.length-1]),l.join("")}}return eval(`template\`${safe}\``)}customElements.define("joomla-field-modal",class extends HTMLElement{constructor(){if(super(),!Joomla)throw new Error("Joomla API is not properly initiated");this.initialText=this.innerText,this.innerText="","function"==typeof Joomla.renderModalField?Joomla.renderModalField.call(this):this.render()}get allow(){return("true"===this.getAttribute("allow-new")?ALLOW_NEW:0)|("true"===this.getAttribute("allow-edit")?ALLOW_EDIT:0)|("false"!==this.getAttribute("allow-clear")?ALLOW_CLEAR:0)|("false"!==this.getAttribute("allow-select")?ALLOW_SELECT:0)}render(){this.createElements(),this.assembleElements()}createElements(){const t=!!this.getAttribute("value");this.elements={},this.elements.wrapper=getElement("span",{class:this.allow?"input-group":""}),this.elements.fieldTitle=getElement("input",{class:"form-control",id:`${this.getAttribute("id")}_name`,type:"text",value:this.initialText,placeholder:this.getAttribute("text-placeholder"),disabled:"disabled",size:"35"}),this.elements.fieldId=getElement("input",{name:this.getAttribute("name"),id:`${this.getAttribute("id")}_id`,type:"hidden",value:this.getAttribute("value"),required:this.getAttribute("required")});const e={role:"button",class:"btn","aria-hidden":"true"};if(this.elements.modalButtonClose=getElement("a",e,this.getAttribute("text-modal-button-close")),this.elements.modalButtonClose.classList.add("btn-secondary"),this.elements.modalButtonClose.setAttribute("data-task","cancel"),this.elements.modalButtonSave=getElement("a",e,this.getAttribute("text-modal-button-save")),this.elements.modalButtonSave.classList.add("btn-primary"),this.elements.modalButtonSave.setAttribute("data-task","save"),this.elements.modalButtonApply=getElement("a",e,this.getAttribute("text-modal-button-apply")),this.elements.modalButtonApply.classList.add("btn-success"),this.elements.modalButtonApply.setAttribute("data-task","apply"),!this.allow)return;this.elements.buttonGroup=getElement("span",{class:"input-group-append"});const s={class:"btn hasTooltip",type:"button"};this.allow&ALLOW_SELECT&&(this.elements.buttonSelect=getElement("button",s,getElement("span",{class:"icon-file","aria-hidden":"true"})," ",this.getAttribute("text-button-select")),this.elements.buttonSelect.classList.add("btn-primary"),this.elements.buttonSelect.classList[t?"add":"remove"]("sr-only"),this.elements.buttonSelect.addEventListener("click",()=>this.modalSelect(),!0)),this.allow&ALLOW_NEW&&(this.elements.buttonNew=getElement("button",s,getElement("span",{class:"icon-new","aria-hidden":"true"})," ",this.getAttribute("text-button-create")),this.elements.buttonNew.classList.add("btn-secondary"),this.elements.buttonNew.classList[t?"add":"remove"]("sr-only"),this.elements.buttonNew.addEventListener("click",()=>this.modalNew(),!0)),this.allow&ALLOW_EDIT&&(this.elements.buttonEdit=getElement("button",s,getElement("span",{class:"icon-edit","aria-hidden":"true"})," ",this.getAttribute("text-button-edit")),this.elements.buttonEdit.classList.add("btn-secondary"),this.elements.buttonEdit.classList[t?"remove":"add"]("sr-only"),this.elements.buttonEdit.addEventListener("click",()=>this.modalEdit(),!0)),this.allow&ALLOW_CLEAR&&(this.elements.buttonClear=getElement("button",s,getElement("span",{class:"icon-remove","aria-hidden":"true"})," ",this.getAttribute("text-button-clear")),this.elements.buttonClear.classList.add("btn-secondary"),this.elements.buttonClear.classList[t?"remove":"add"]("sr-only"),this.elements.buttonClear.addEventListener("click",()=>this.clear(),!0))}assembleElements(){this.elements.wrapper.appendChild(this.elements.fieldId),this.elements.wrapper.appendChild(this.elements.fieldTitle),this.elements.buttonGroup&&(this.elements.wrapper.appendChild(this.elements.buttonGroup),this.elements.buttonSelect&&this.elements.buttonGroup.appendChild(this.elements.buttonSelect),this.elements.buttonNew&&this.elements.buttonGroup.appendChild(this.elements.buttonNew),this.elements.buttonEdit&&this.elements.buttonGroup.appendChild(this.elements.buttonEdit),this.elements.buttonClear&&this.elements.buttonGroup.appendChild(this.elements.buttonClear)),this.appendChild(this.elements.wrapper)}modalSelect(){const t=this.getAttribute("text-title-select"),e=getElement("iframe",{class:"iframe",src:this.getAttribute("url-select"),name:""}),s=getElement("a",{role:"button",class:"btn btn-secondary","data-dismiss":"modal","aria-hidden":"true"},"Close");this.openModal(t,e,s,{closeButton:!0}).then(t=>this.processResult(...t),()=>{})}modalNew(){const t=this.getAttribute("text-title-new"),e=getElement("iframe",{class:"iframe",src:this.getAttribute("url-new"),name:""}),s=[this.elements.modalButtonClose,this.elements.modalButtonSave,this.elements.modalButtonApply];this.openModal(t,e,s,{backdrop:"static",keyboard:!1,closeButton:!1}).then(t=>this.processResult(...t),()=>{})}modalEdit(){const t=templateFactory(this.getAttribute("url-edit")),e=this.getAttribute("text-title-edit"),s=getElement("iframe",{class:"iframe",src:t(this.elements.fieldId.value),name:""}),l=[this.elements.modalButtonClose,this.elements.modalButtonSave,this.elements.modalButtonApply];this.openModal(e,s,l,{backdrop:"static",keyboard:!1,closeButton:!1}).then(t=>this.processResult(...t),()=>{})}clear(){this.processResult()}openModal(t,e,s,l){const n=e instanceof Array?e:[e],i=s instanceof Array?s:[s],o=getElement("div",{role:"dialog",tabindex:"-1",class:"joomla-modal modal fade show"},getElement("div",{class:"modal-dialog modal-lg jviewport-width80",role:"document"},getElement("div",{class:"modal-content"},getElement("div",{class:"modal-header"},getElement("h3",{class:"modal-title"},t||"Title"),l.closeButton?getElement("button",{type:"button",class:"close novalidate","data-dismiss":"modal"},"Ã—"):""),getElement("div",{class:"modal-body jviewport-height70"},...n),getElement("div",{class:"modal-footer"},...i)))),a=[].slice.call(o.getElementsByTagName("iframe")).shift();a&&(o.classList.add("sr-only"),a.addEventListener("load",function t(){o.classList.remove("sr-only"),a.removeEventListener("load",t)}));let d=null;window.jModalSelect=((...t)=>{d=t,$(o).modal("hide")});const m=t=>{const e=t.target.getAttribute("data-task")||"cancel",s=(this.getAttribute("item-type")||"item").toLowerCase(),l=this.getAttribute("form-id")||`${s}-form`,n=this.getAttribute("id-field-id")||"jform_id",i=this.getAttribute("title-field-id")||"jform_title",m=a.contentWindow,r=a.contentDocument;"cancel"===e&&(m.Joomla.submitbutton(`${s}.${e}`),$(o).modal("hide")),r.formvalidator.isValid(r.getElementById(l))&&(a.addEventListener("load",function t(){a.removeEventListener("load",t);const l=a.contentDocument,r=l.getElementById(n),u=l.getElementById(i);r&&"0"!==r.value&&(d=[r.value,u&&u.value],"save"===e&&(m.Joomla.submitbutton(`${s}.cancel`),$(o).modal("hide"))),a.classList.remove("sr-only")}),"save"===e&&a.classList.add("sr-only"),m.Joomla.submitbutton(`${s}.apply`))};[this.elements.modalButtonClose,this.elements.modalButtonSave,this.elements.modalButtonApply].forEach(t=>{if(!t.parentNode)return;const e=t.cloneNode(!0);t.parentNode.replaceChild(e,t),e.addEventListener("click",t=>m(t))}),$(o).modal(l).one("hidden.bs.modal",()=>o.parentNode.removeChild(o));const r=new Promise((t,e)=>{$(o).one("hide.bs.modal",()=>{d?t(d):e()})});return r.finally(()=>{window.jModalSelect=null}),r}processResult(t="",e="",s="",l="",n="",i=""){this.elements.fieldId.value=t||"",this.elements.fieldTitle.value=t?e:"",this.elements.buttonSelect&&this.elements.buttonSelect.classList[t?"add":"remove"]("sr-only"),this.elements.buttonNew&&this.elements.buttonNew.classList[t?"add":"remove"]("sr-only"),this.elements.buttonEdit&&this.elements.buttonEdit.classList[t?"remove":"add"]("sr-only"),this.elements.buttonClear&&this.elements.buttonClear.classList[t?"remove":"add"]("sr-only"),"1"===this.elements.fieldId.getAttribute("data-required")&&(document.formvalidator.validate(this.elements.fieldId),document.formvalidator.validate(this.elements.fieldTitle))}})})(customElements,Joomla,jQuery);
