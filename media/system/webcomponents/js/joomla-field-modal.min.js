((customElements,Joomla,$)=>{const ALLOW_NEW=1,ALLOW_EDIT=2,ALLOW_CLEAR=4,ALLOW_SELECT=8;function getElement(t,e,...s){let l=document.createElement(t);if(e)for(let t in e)e.hasOwnProperty(t)&&l.setAttribute(t,e[t]);return s.forEach(t=>{"string"==typeof t?l.appendChild(document.createTextNode(t)):t instanceof HTMLElement&&l.appendChild(t)}),l}function templateFactory(tmpl){function template(t,...e){return(...s)=>{let l=e.map((e,l)=>t[l]+s[parseInt(e)]);return l.push(t[t.length-1]),l.join("")}}return tmpl=tmpl.replace(/\\|`/g,"\\$&"),eval("template`"+tmpl+"`")}customElements.define("joomla-field-modal",class extends HTMLElement{constructor(){if(super(),!Joomla)throw new Error("Joomla API is not properly initiated");this.initialText=this.innerText,this.innerText="","function"==typeof Joomla.renderModalField?Joomla.renderModalField.call(this):this.render()}get allow(){return("true"===this.getAttribute("allow-new")?ALLOW_NEW:0)|("true"===this.getAttribute("allow-edit")?ALLOW_EDIT:0)|("false"!==this.getAttribute("allow-clear")?ALLOW_CLEAR:0)|("false"!==this.getAttribute("allow-select")?ALLOW_SELECT:0)}render(){this.createElements(),this.assembleElements()}createElements(){const t=!!this.getAttribute("value");this.elements={},this.elements.wrapper=getElement("span",{class:this.allow?"input-group":""}),this.elements.fieldTitle=getElement("input",{class:"form-control",id:this.getAttribute("id")+"_name",type:"text",value:this.initialText,placeholder:this.getAttribute("text-placeholder"),disabled:"disabled",size:"35"}),this.elements.fieldId=getElement("input",{name:this.getAttribute("name"),id:this.getAttribute("id")+"_id",type:"hidden",value:this.getAttribute("value"),required:this.getAttribute("required")});const e={role:"button",class:"btn","aria-hidden":"true"};if(this.elements.modalButtonClose=getElement("a",e,this.getAttribute("text-modal-button-close")),this.elements.modalButtonClose.classList.add("btn-secondary"),this.elements.modalButtonClose.setAttribute("data-task","cancel"),this.elements.modalButtonSave=getElement("a",e,this.getAttribute("text-modal-button-save")),this.elements.modalButtonSave.classList.add("btn-primary"),this.elements.modalButtonSave.setAttribute("data-task","save"),this.elements.modalButtonApply=getElement("a",e,this.getAttribute("text-modal-button-apply")),this.elements.modalButtonApply.classList.add("btn-success"),this.elements.modalButtonApply.setAttribute("data-task","apply"),!this.allow)return;this.elements.buttonGroup=getElement("span",{class:"input-group-append"});let s={class:"btn hasTooltip",type:"button"};this.allow&ALLOW_SELECT&&(this.elements.buttonSelect=getElement("button",s,getElement("span",{class:"icon-file","aria-hidden":"true"})," ",this.getAttribute("text-button-select")),this.elements.buttonSelect.classList.add("btn-primary"),this.elements.buttonSelect.classList[t?"add":"remove"]("sr-only"),this.elements.buttonSelect.addEventListener("click",t=>this.modalSelect(t),!0)),this.allow&ALLOW_NEW&&(this.elements.buttonNew=getElement("button",s,getElement("span",{class:"icon-new","aria-hidden":"true"})," ",this.getAttribute("text-button-create")),this.elements.buttonNew.classList.add("btn-secondary"),this.elements.buttonNew.classList[t?"add":"remove"]("sr-only"),this.elements.buttonNew.addEventListener("click",t=>this.modalNew(t),!0)),this.allow&ALLOW_EDIT&&(this.elements.buttonEdit=getElement("button",s,getElement("span",{class:"icon-edit","aria-hidden":"true"})," ",this.getAttribute("text-button-edit")),this.elements.buttonEdit.classList.add("btn-secondary"),this.elements.buttonEdit.classList[t?"remove":"add"]("sr-only"),this.elements.buttonEdit.addEventListener("click",t=>this.modalEdit(t),!0)),this.allow&ALLOW_CLEAR&&(this.elements.buttonClear=getElement("button",s,getElement("span",{class:"icon-remove","aria-hidden":"true"})," ",this.getAttribute("text-button-clear")),this.elements.buttonClear.classList.add("btn-secondary"),this.elements.buttonClear.classList[t?"remove":"add"]("sr-only"),this.elements.buttonClear.addEventListener("click",t=>this.clear(t),!0))}assembleElements(){this.elements.wrapper.appendChild(this.elements.fieldId),this.elements.wrapper.appendChild(this.elements.fieldTitle),this.elements.buttonGroup&&(this.elements.wrapper.appendChild(this.elements.buttonGroup),this.elements.buttonSelect&&this.elements.buttonGroup.appendChild(this.elements.buttonSelect),this.elements.buttonNew&&this.elements.buttonGroup.appendChild(this.elements.buttonNew),this.elements.buttonEdit&&this.elements.buttonGroup.appendChild(this.elements.buttonEdit),this.elements.buttonClear&&this.elements.buttonGroup.appendChild(this.elements.buttonClear)),this.appendChild(this.elements.wrapper)}modalSelect(t){const e=this.getAttribute("text-title-select");let s=getElement("iframe",{class:"iframe",src:this.getAttribute("url-select"),name:""}),l=getElement("a",{role:"button",class:"btn btn-secondary","data-dismiss":"modal","aria-hidden":"true"},"Close");this.openModal(e,s,l,{closeButton:!0}).then(t=>this.processResult(...t),t=>{})}modalNew(t){const e=this.getAttribute("text-title-new");let s=getElement("iframe",{class:"iframe",src:this.getAttribute("url-new"),name:""}),l=[this.elements.modalButtonClose,this.elements.modalButtonSave,this.elements.modalButtonApply];this.openModal(e,s,l,{backdrop:"static",keyboard:!1,closeButton:!1}).then(t=>this.processResult(...t),t=>{})}modalEdit(t){const e=templateFactory(this.getAttribute("url-edit")),s=this.getAttribute("text-title-edit");let l=getElement("iframe",{class:"iframe",src:e(this.elements.fieldId.value),name:""}),n=[this.elements.modalButtonClose,this.elements.modalButtonSave,this.elements.modalButtonApply];this.openModal(s,l,n,{backdrop:"static",keyboard:!1,closeButton:!1}).then(t=>this.processResult(...t),t=>{})}clear(t){this.processResult()}openModal(t,e,s,l){e=e instanceof Array?e:[e],s=s instanceof Array?s:[s];const n=getElement("div",{role:"dialog",tabindex:"-1",class:"joomla-modal modal fade show"},getElement("div",{class:"modal-dialog modal-lg jviewport-width80",role:"document"},getElement("div",{class:"modal-content"},getElement("div",{class:"modal-header"},getElement("h3",{class:"modal-title"},t||"Title"),l.closeButton?getElement("button",{type:"button",class:"close novalidate","data-dismiss":"modal"},"Ã—"):""),getElement("div",{class:"modal-body jviewport-height70"},...e),getElement("div",{class:"modal-footer"},...s)))),i=[].slice.call(n.getElementsByTagName("iframe")).shift();i&&(n.classList.add("sr-only"),i.addEventListener("load",function t(){n.classList.remove("sr-only"),i.removeEventListener("load",t)}));let o=null;window.jModalSelect=((...t)=>{o=t,$(n).modal("hide")});const a=t=>{const e=t.target.getAttribute("data-task")||"cancel",s=(this.getAttribute("item-type")||"item").toLowerCase(),l=this.getAttribute("form-id")||`${s}-form`,i=this.getAttribute("id-field-id")||"jform_id",a=this.getAttribute("title-field-id")||"jform_title",d=[].slice.call(n.getElementsByTagName("iframe")).shift(),m=d.contentWindow,r=d.contentDocument;"cancel"===e&&(m.Joomla.submitbutton(`${s}.${e}`),$(n).modal("hide")),r.formvalidator.isValid(r.getElementById(l))&&(d.addEventListener("load",function t(){d.removeEventListener("load",t);const l=d.contentDocument,r=l.getElementById(i),u=l.getElementById(a);r&&"0"!==r.value&&(o=[r.value,u&&u.value],"save"===e&&(m.Joomla.submitbutton(`${s}.cancel`),$(n).modal("hide"))),d.classList.remove("sr-only")}),"save"===e&&d.classList.add("sr-only"),m.Joomla.submitbutton(`${s}.apply`))};[this.elements.modalButtonClose,this.elements.modalButtonSave,this.elements.modalButtonApply].forEach(t=>{if(!t.parentNode)return;const e=t.cloneNode(!0);t.parentNode.replaceChild(e,t),e.addEventListener("click",t=>a(t))}),$(n).modal(l).one("hidden.bs.modal",()=>n.parentNode.removeChild(n));const d=new Promise((t,e)=>{$(n).one("hide.bs.modal",s=>o?t(o):e())});return d.finally(()=>{window.jModalSelect=null}),d}processResult(t="",e="",s="",l="",n="",i=""){this.elements.fieldId.value=t||"",this.elements.fieldTitle.value=t?e:"",this.elements.buttonSelect&&this.elements.buttonSelect.classList[t?"add":"remove"]("sr-only"),this.elements.buttonNew&&this.elements.buttonNew.classList[t?"add":"remove"]("sr-only"),this.elements.buttonEdit&&this.elements.buttonEdit.classList[t?"remove":"add"]("sr-only"),this.elements.buttonClear&&this.elements.buttonClear.classList[t?"remove":"add"]("sr-only"),"1"===this.elements.fieldId.getAttribute("data-required")&&(document.formvalidator.validate(this.elements.fieldId),document.formvalidator.validate(this.elements.fieldTitle))}})})(customElements,Joomla,jQuery);