---
kind: pipeline
name: default

clone:
  depth: 42

steps:
  - name: selenium-chrome-1
    image: selenium/standalone-chrome:3.141.59-radium
    shm_size: 2048000000
    shm-size: 2048000000
    commands:
      - df /dev/shm

  - name: selenium-chrome-2
    image: selenium/standalone-chrome:3.141.59-radium
    shm-size: 2048000000
    commands:
      - df /dev/shm

  - name: selenium-chrome-3
    image: selenium/standalone-chrome:3.141.59-radium
    shm_size: 2048000000
    commands:
      - df /dev/shm

  - name: restore-cache
    image: drillster/drone-volume-cache
    settings:
      restore: true
      mount:
        - ./node_modules
        - ./libraries/vendor
        - ./administrator/components/com_media/node_modules
      cache_key: [ DRONE_REPO_NAMESPACE, DRONE_REPO_NAME, DRONE_BRANCH, DRONE_STAGE_NUMBER ]
    volumes:
      - name: cache
        path: /cache

  - name: composer
    image: joomlaprojects/docker-tools:develop
    depends_on: [ restore-cache ]
    commands:
      - composer install --no-progress --no-suggest

  - name: npm
    image: joomlaprojects/docker-tools:develop
    depends_on: [ composer ]
    commands:
      - npm install --unsafe-perm

  - name: rebuild-cache
    image: drillster/drone-volume-cache
    depends_on: [ npm ]
    settings:
      rebuild: true
      mount:
        - ./node_modules
        - ./libraries/vendor
        - ./administrator/components/com_media/node_modules
      cache_key: [ DRONE_REPO_NAMESPACE, DRONE_REPO_NAME, DRONE_BRANCH, DRONE_STAGE_NUMBER ]
    volumes:
      - name: cache
        path: /cache

  - name: system-tests-mysql
    depends_on: [ npm ]
    image: joomlaprojects/docker-systemtests:latest
    commands:
      - bash tests/Codeception/drone-system-run.sh "$(pwd)" mysql

branches:
  exclude: [ l10n_* ]


volumes:
  - name: cache
    host:
      path: /tmp/cache

services:
  - name: mysql
    image: mysql:5.7
    environment:
      MYSQL_USER: joomla_ut
      MYSQL_PASSWORD: joomla_ut
      MYSQL_ROOT_PASSWORD: joomla_ut
      MYSQL_DATABASE: test_joomla

  - name: memcached
    image: memcached:alpine

  - name: redis
    image: redis:alpine

  - name: postgres
    image: postgres:9-alpine
    ports:
      - 5432
    environment:
      POSTGRES_USER: root
      POSTGRES_PASSWORD: joomla_ut
      POSTGRES_DB: test_joomla

  - name: selenium-chrome
    image: selenium/standalone-chrome:3.141.59-radium
    shm_size: 2048000000
    shm-size: 2048000000

  - name: selenium-firefox
    image: selenium/standalone-firefox:3.141.59-radium


---
kind: signature
hmac: 391873561faec01641c729a5fc30ebdb07c4e2782b7b713b3f7d150321cdaff7

...
